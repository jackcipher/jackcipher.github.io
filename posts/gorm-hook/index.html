<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GORM Hook 使用误区 | Jack</title>
<meta name=keywords content="gorm,go"><meta name=description content="背景
在 office-gateway 三期优化过程中，对任务数据实现了缓存机制，旨在提高查询性能。考虑到数据写操作频繁，且当前仅有一个接口负责读取，属于典型的写多读少场景。于是决定选用 GORM 的 Hook 机制来更新缓存。"><meta name=author content><link rel=canonical href=https://jackcipher.github.io/posts/gorm-hook/><link crossorigin=anonymous href=/assets/css/stylesheet.94d82ef922bb302b4b47e18817731947783f737df57223d70b108087295a1853.css integrity="sha256-lNgu+SK7MCtLR+GIF3MZR3g/c331ciPXCxCAhylaGFM=" rel="preload stylesheet" as=style><link rel=icon href=https://jackcipher.github.io/static/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jackcipher.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jackcipher.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jackcipher.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jackcipher.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://jackcipher.github.io/posts/gorm-hook/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="GORM Hook 使用误区"><meta property="og:description" content="背景
在 office-gateway 三期优化过程中，对任务数据实现了缓存机制，旨在提高查询性能。考虑到数据写操作频繁，且当前仅有一个接口负责读取，属于典型的写多读少场景。于是决定选用 GORM 的 Hook 机制来更新缓存。"><meta property="og:type" content="article"><meta property="og:url" content="https://jackcipher.github.io/posts/gorm-hook/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-01T03:17:25+00:00"><meta property="article:modified_time" content="2024-11-01T03:17:25+00:00"><meta property="og:site_name" content="Jack"><meta name=twitter:card content="summary"><meta name=twitter:title content="GORM Hook 使用误区"><meta name=twitter:description content="背景
在 office-gateway 三期优化过程中，对任务数据实现了缓存机制，旨在提高查询性能。考虑到数据写操作频繁，且当前仅有一个接口负责读取，属于典型的写多读少场景。于是决定选用 GORM 的 Hook 机制来更新缓存。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jackcipher.github.io/posts/"},{"@type":"ListItem","position":2,"name":"GORM Hook 使用误区","item":"https://jackcipher.github.io/posts/gorm-hook/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GORM Hook 使用误区","name":"GORM Hook 使用误区","description":"背景 在 office-gateway 三期优化过程中，对任务数据实现了缓存机制，旨在提高查询性能。考虑到数据写操作频繁，且当前仅有一个接口负责读取，属于典型的写多读少场景。于是决定选用 GORM 的 Hook 机制来更新缓存。\n","keywords":["gorm","go"],"articleBody":"背景 在 office-gateway 三期优化过程中，对任务数据实现了缓存机制，旨在提高查询性能。考虑到数据写操作频繁，且当前仅有一个接口负责读取，属于典型的写多读少场景。于是决定选用 GORM 的 Hook 机制来更新缓存。\n实现方案 在 Model 结构体上实现 GORM 的 AfterUpdate 和 AfterCreate 方法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func (c *GatewayTasks) AfterUpdate(tx *gorm.DB) error { err := invokerbase.TaskCache.SetMainTaskCache(context.Background(), c.TaskID, c.TaskType, c.Bytes()) if err != nil { elog.Error(\"hook.GatewayTasks.SetCache.failed\", l.E(err)) } return nil } func (c *GatewayTasks) AfterCreate(tx *gorm.DB) error { err := invokerbase.TaskCache.SetMainTaskCache(context.Background(), c.TaskID, c.TaskType, c.Bytes()) if err != nil { elog.Error(\"hook.GatewayTasks.SetCache.failed\", l.E(err)) } return nil } 问题诊断 代码发布后，我们发现了以下异常：\n缓存更新仅在创建数据时生效 更新数据表时虽然触发了 Hook 函数，但写入的数据不正确 测试反馈获取进度非常缓慢，不论文件大小，耗时均约 5s 问题分析 通过观察发现：\n新部署机器规格较高，转码时间很快 缓存过期时间为 5s 文件大小不同，转码耗时却保持一致 这些现象强烈暗示可能存在缓存脏数据问题，导致流程无法正常结束。仅在缓存过期后，系统才能穿透到数据表获取最终结果。\n源码分析 GORM 回调机制简述 GORM 的 Update 方法实质上是触发一系列回调函数，而非直接执行 SQL：\n1 2 3 4 5 6 // Update updates column with value using callbacks. Reference: (db *DB) Update(column string, value interface{}) (tx *DB) { tx = db.getInstance() tx.Statement.Dest = map[string]interface{}{column: value} return tx.callbacks.Update().Execute(tx) } 回调注册与执行 gorm.Open 时会初始化 Dialecter Dialecter 初始化时通过 RegisterDefaultCallbacks 注册默认回调函数 after_update 就是在这里初始化的 执行顺序由 sortCallbacks 决定回调执行顺序 不同类型的回调（如 before_update、after_update）在数据库操作的不同阶段被触发 AfterUpdate 定义 通过 AfterUpdate 来看，传给自定义回调函数中的 Model 本质上是参数 i，而 i 的值是 callmethod 通过 value 给的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // AfterUpdate after update hooksfunc AfterUpdate(db *gorm.DB) { if db.Error == nil \u0026\u0026 db.Statement.Schema != nil \u0026\u0026 !db.Statement.SkipHooks \u0026\u0026 (db.Statement.Schema.AfterSave || db.Statement.Schema.AfterUpdate) { callMethod(db, func(value interface{}, tx *gorm.DB) (called bool) { if db.Statement.Schema.AfterUpdate { if i, ok := value.(AfterUpdateInterface); ok { called = true db.AddError(i.AfterUpdate(tx)) } } if db.Statement.Schema.AfterSave { if i, ok := value.(AfterSaveInterface); ok { called = true db.AddError(i.AfterSave(tx)) } } return called }) } } 再看 callmethod 方法的定义，不难发现，db.Statement.ReflectValue 最终会影响 value 的值。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func callMethod(db *gorm.DB, fc func(value interface{}, tx *gorm.DB) bool) { tx := db.Session(\u0026gorm.Session{NewDB: true}) if called := fc(db.Statement.ReflectValue.Interface(), tx); !called { switch db.Statement.ReflectValue.Kind() { case reflect.Slice, reflect.Array: db.Statement.CurDestIndex = 0 for i := 0; i \u003c db.Statement.ReflectValue.Len(); i++ { if value := reflect.Indirect(db.Statement.ReflectValue.Index(i)); value.CanAddr() { fc(value.Addr().Interface(), tx) } else { db.AddError(gorm.ErrInvalidValue) return } db.Statement.CurDestIndex++ } case reflect.Struct: if db.Statement.ReflectValue.CanAddr() { fc(db.Statement.ReflectValue.Addr().Interface(), tx) } else { db.AddError(gorm.ErrInvalidValue) } } } } 继续追踪源码发现，Update 的 ReflectValue 是通过 SetupUpdateReflectValue 这个 Hook 函数实现的，最终是来自 db.Statement.Model\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func SetupUpdateReflectValue(db *gorm.DB) { if db.Error == nil \u0026\u0026 db.Statement.Schema != nil { if !db.Statement.ReflectValue.CanAddr() || db.Statement.Model != db.Statement.Dest { db.Statement.ReflectValue = reflect.ValueOf(db.Statement.Model) for db.Statement.ReflectValue.Kind() == reflect.Ptr { db.Statement.ReflectValue = db.Statement.ReflectValue.Elem() } if dest, ok := db.Statement.Dest.(map[string]interface{}); ok { for _, rel := range db.Statement.Schema.Relationships.BelongsTo { if _, ok := dest[rel.Name]; ok { db.AddError(rel.Field.Set(db.Statement.Context, db.Statement.ReflectValue, dest[rel.Name])) } } } } } } 关键点在于 db.Statement.Model 的赋值机制：\nModel 方法通常传入一个空结构体：db.Model(\u0026GatewayTasks{}) Update 回调在与数据库交互后会更新 db.Statement.Model AfterUpdate Hook 中的 tx 参数即是这个更新后的 Statement 根本原因 问题的根源在于 Update 调用时仅更新部分字段（如 taskStatus），而未包含构建缓存所需的 taskID 和 taskType。这导致 Hook 函数虽然执行，但无法正确设置缓存。 而 Create 时，包含了这些字段，导致在 Create 阶段产生了缓存，后续的更新操作未更新缓存，导致了脏数据。\n解决方法 通过分析业务代码发现，更新任务之前，都会先拿到任务信息，都具备获取到 Model 结构体。 调整更新逻辑：\n更新前获取完整任务信息 直接修改 Model 中需要变更的值 使用完整 Model 执行 Update 操作 总结 GORM 不会凭空产生数据，并不具备类似 binlog 的能力 GORM Hook 中的 Model 的数据，是从 Update 方法中解析出来的 在使用 Hook 时，一定要清楚 Model 中哪些字段能够拿到，哪些拿不到 ","wordCount":"1290","inLanguage":"zh","datePublished":"2024-11-01T03:17:25Z","dateModified":"2024-11-01T03:17:25Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://jackcipher.github.io/posts/gorm-hook/"},"publisher":{"@type":"Organization","name":"Jack","logo":{"@type":"ImageObject","url":"https://jackcipher.github.io/static/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jackcipher.github.io/ accesskey=h title="Jack (Alt + H)">Jack</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://jackcipher.github.io/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://jackcipher.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://jackcipher.github.io/leetcode/ title=LeetCode><span>LeetCode</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">GORM Hook 使用误区</h1><div class=post-meta><span title='2024-11-01 03:17:25 +0000 UTC'>2024-11-01</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><div class=inner><ul><li><div class=item><div class=circle></div><a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></div></li><li><div class=item><div class=circle></div><a href=#%e5%ae%9e%e7%8e%b0%e6%96%b9%e6%a1%88 aria-label=实现方案>实现方案</a></div></li><li><div class=item><div class=circle></div><a href=#%e9%97%ae%e9%a2%98%e8%af%8a%e6%96%ad aria-label=问题诊断>问题诊断</a></div><ul><li><div class=item><div class=circle></div><a href=#%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90 aria-label=问题分析>问题分析</a></div></li><li><div class=item><div class=circle></div><a href=#%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90 aria-label=源码分析>源码分析</a></div><ul><li><div class=item><div class=circle></div><a href=#gorm-%e5%9b%9e%e8%b0%83%e6%9c%ba%e5%88%b6%e7%ae%80%e8%bf%b0 aria-label="GORM 回调机制简述">GORM 回调机制简述</a></div></li><li><div class=item><div class=circle></div><a href=#%e5%9b%9e%e8%b0%83%e6%b3%a8%e5%86%8c%e4%b8%8e%e6%89%a7%e8%a1%8c aria-label=回调注册与执行>回调注册与执行</a></div></li><li><div class=item><div class=circle></div><a href=#afterupdate-%e5%ae%9a%e4%b9%89 aria-label="AfterUpdate 定义">AfterUpdate 定义</a></div></li></ul></li><li><div class=item><div class=circle></div><a href=#%e6%a0%b9%e6%9c%ac%e5%8e%9f%e5%9b%a0 aria-label=根本原因>根本原因</a></div></li></ul></li><li><div class=item><div class=circle></div><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%b3%95 aria-label=解决方法>解决方法</a></div></li><li><div class=item><div class=circle></div><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></div></li></ul></div></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){history.scrollRestoration&&(history.scrollRestoration="manual"),checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"),document.querySelector(`.inner ul li .item:has(a[href="#${t}"])`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?(document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"),document.querySelector(`.inner ul li .item:has(a[href="#${t}"])`).classList.add("active")):(document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active"),document.querySelector(`.inner ul li .item:has(a[href="#${t}"])`).classList.remove("active"))})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h1><p>在 office-gateway 三期优化过程中，对任务数据实现了缓存机制，旨在提高查询性能。考虑到数据写操作频繁，且当前仅有一个接口负责读取，属于典型的写多读少场景。于是决定选用 GORM 的 Hook 机制来更新缓存。</p><h1 id=实现方案>实现方案<a hidden class=anchor aria-hidden=true href=#实现方案>#</a></h1><p>在 Model 结构体上实现 GORM 的 AfterUpdate 和 AfterCreate 方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>c</span> <span class=o>*</span><span class=n>GatewayTasks</span><span class=p>)</span> <span class=n>AfterUpdate</span><span class=p>(</span><span class=n>tx</span> <span class=o>*</span><span class=n>gorm</span><span class=o>.</span><span class=n>DB</span><span class=p>)</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>invokerbase</span><span class=o>.</span><span class=n>TaskCache</span><span class=o>.</span><span class=n>SetMainTaskCache</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>Background</span><span class=p>(),</span> <span class=n>c</span><span class=o>.</span><span class=n>TaskID</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>TaskType</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>elog</span><span class=o>.</span><span class=n>Error</span><span class=p>(</span><span class=s2>&#34;hook.GatewayTasks.SetCache.failed&#34;</span><span class=p>,</span> <span class=n>l</span><span class=o>.</span><span class=n>E</span><span class=p>(</span><span class=n>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>func</span> <span class=p>(</span><span class=n>c</span> <span class=o>*</span><span class=n>GatewayTasks</span><span class=p>)</span> <span class=n>AfterCreate</span><span class=p>(</span><span class=n>tx</span> <span class=o>*</span><span class=n>gorm</span><span class=o>.</span><span class=n>DB</span><span class=p>)</span> <span class=n>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>invokerbase</span><span class=o>.</span><span class=n>TaskCache</span><span class=o>.</span><span class=n>SetMainTaskCache</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>Background</span><span class=p>(),</span> <span class=n>c</span><span class=o>.</span><span class=n>TaskID</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>TaskType</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>elog</span><span class=o>.</span><span class=n>Error</span><span class=p>(</span><span class=s2>&#34;hook.GatewayTasks.SetCache.failed&#34;</span><span class=p>,</span> <span class=n>l</span><span class=o>.</span><span class=n>E</span><span class=p>(</span><span class=n>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h1 id=问题诊断>问题诊断<a hidden class=anchor aria-hidden=true href=#问题诊断>#</a></h1><p>代码发布后，我们发现了以下异常：</p><ol><li>缓存更新仅在创建数据时生效</li><li>更新数据表时虽然触发了 Hook 函数，但写入的数据不正确</li><li>测试反馈获取进度非常缓慢，不论文件大小，耗时均约 5s</li></ol><h2 id=问题分析>问题分析<a hidden class=anchor aria-hidden=true href=#问题分析>#</a></h2><p>通过观察发现：</p><ul><li>新部署机器规格较高，转码时间很快</li><li>缓存过期时间为 5s</li><li>文件大小不同，转码耗时却保持一致</li></ul><p>这些现象强烈暗示可能存在缓存脏数据问题，导致流程无法正常结束。仅在缓存过期后，系统才能穿透到数据表获取最终结果。</p><h2 id=源码分析>源码分析<a hidden class=anchor aria-hidden=true href=#源码分析>#</a></h2><h3 id=gorm-回调机制简述>GORM 回调机制简述<a hidden class=anchor aria-hidden=true href=#gorm-回调机制简述>#</a></h3><p>GORM 的 <code>Update</code> 方法实质上是触发一系列回调函数，而非直接执行 SQL：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Update updates column with value using callbacks. Reference: &lt;https://gorm.io/docs/update.html#Update-Changed-Fieldsfunc&gt; (db *DB) Update(column string, value interface{}) (tx *DB) {
</span></span><span class=line><span class=cl>tx = db.getInstance()
</span></span><span class=line><span class=cl>tx.Statement.Dest = map[string]interface{}{column: value}
</span></span><span class=line><span class=cl>return tx.callbacks.Update().Execute(tx)
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=回调注册与执行>回调注册与执行<a hidden class=anchor aria-hidden=true href=#回调注册与执行>#</a></h3><ul><li>gorm.Open 时会初始化 Dialecter</li><li>Dialecter 初始化时通过 <code>RegisterDefaultCallbacks</code> 注册默认回调函数<ul><li>after_update 就是在这里初始化的</li></ul></li><li>执行顺序由 <code>sortCallbacks</code> 决定回调执行顺序</li><li>不同类型的回调（如 <code>before_update</code>、<code>after_update</code>）在数据库操作的不同阶段被触发</li></ul><h3 id=afterupdate-定义>AfterUpdate 定义<a hidden class=anchor aria-hidden=true href=#afterupdate-定义>#</a></h3><p>通过 AfterUpdate 来看，传给自定义回调函数中的 Model 本质上是参数 i，而 i 的值是 callmethod 通过 value 给的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>AfterUpdate</span> <span class=n>after</span> <span class=n>update</span> <span class=n>hooksfunc</span> <span class=n>AfterUpdate</span><span class=p>(</span><span class=n>db</span> <span class=o>*</span><span class=n>gorm</span><span class=o>.</span><span class=n>DB</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>db</span><span class=o>.</span><span class=n>Error</span> <span class=o>==</span> <span class=n>nil</span> <span class=o>&amp;&amp;</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Schema</span> <span class=o>!=</span> <span class=n>nil</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>SkipHooks</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Schema</span><span class=o>.</span><span class=n>AfterSave</span> <span class=o>||</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Schema</span><span class=o>.</span><span class=n>AfterUpdate</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>callMethod</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=k>func</span><span class=p>(</span><span class=n>value</span> <span class=n>interface</span><span class=p>{},</span> <span class=n>tx</span> <span class=o>*</span><span class=n>gorm</span><span class=o>.</span><span class=n>DB</span><span class=p>)</span> <span class=p>(</span><span class=n>called</span> <span class=ne>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Schema</span><span class=o>.</span><span class=n>AfterUpdate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=k>if</span> <span class=n>i</span><span class=p>,</span> <span class=n>ok</span> <span class=p>:</span><span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=p>(</span><span class=n>AfterUpdateInterface</span><span class=p>);</span> <span class=n>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>called</span> <span class=o>=</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>                <span class=n>db</span><span class=o>.</span><span class=n>AddError</span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>AfterUpdate</span><span class=p>(</span><span class=n>tx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Schema</span><span class=o>.</span><span class=n>AfterSave</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=k>if</span> <span class=n>i</span><span class=p>,</span> <span class=n>ok</span> <span class=p>:</span><span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=p>(</span><span class=n>AfterSaveInterface</span><span class=p>);</span> <span class=n>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>called</span> <span class=o>=</span> <span class=bp>true</span>
</span></span><span class=line><span class=cl>                <span class=n>db</span><span class=o>.</span><span class=n>AddError</span><span class=p>(</span><span class=n>i</span><span class=o>.</span><span class=n>AfterSave</span><span class=p>(</span><span class=n>tx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=n>called</span>
</span></span><span class=line><span class=cl>       <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>再看 callmethod 方法的定义，不难发现，db.Statement.ReflectValue 最终会影响 value 的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>callMethod</span><span class=p>(</span><span class=n>db</span> <span class=o>*</span><span class=n>gorm</span><span class=o>.</span><span class=n>DB</span><span class=p>,</span> <span class=n>fc</span> <span class=k>func</span><span class=p>(</span><span class=n>value</span> <span class=n>interface</span><span class=p>{},</span> <span class=n>tx</span> <span class=o>*</span><span class=n>gorm</span><span class=o>.</span><span class=n>DB</span><span class=p>)</span> <span class=ne>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>tx</span> <span class=p>:</span><span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Session</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gorm</span><span class=o>.</span><span class=n>Session</span><span class=p>{</span><span class=n>NewDB</span><span class=p>:</span> <span class=bp>true</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>called</span> <span class=p>:</span><span class=o>=</span> <span class=n>fc</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>Interface</span><span class=p>(),</span> <span class=n>tx</span><span class=p>);</span> <span class=o>!</span><span class=n>called</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=k>switch</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>Kind</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=k>case</span> <span class=n>reflect</span><span class=o>.</span><span class=n>Slice</span><span class=p>,</span> <span class=n>reflect</span><span class=o>.</span><span class=n>Array</span><span class=p>:</span>
</span></span><span class=line><span class=cl>          <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>CurDestIndex</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=n>i</span> <span class=p>:</span><span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>Len</span><span class=p>();</span> <span class=n>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=k>if</span> <span class=n>value</span> <span class=p>:</span><span class=o>=</span> <span class=n>reflect</span><span class=o>.</span><span class=n>Indirect</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>Index</span><span class=p>(</span><span class=n>i</span><span class=p>));</span> <span class=n>value</span><span class=o>.</span><span class=n>CanAddr</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>fc</span><span class=p>(</span><span class=n>value</span><span class=o>.</span><span class=n>Addr</span><span class=p>()</span><span class=o>.</span><span class=n>Interface</span><span class=p>(),</span> <span class=n>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>db</span><span class=o>.</span><span class=n>AddError</span><span class=p>(</span><span class=n>gorm</span><span class=o>.</span><span class=n>ErrInvalidValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>             <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>CurDestIndex</span><span class=o>++</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=k>case</span> <span class=n>reflect</span><span class=o>.</span><span class=n>Struct</span><span class=p>:</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>CanAddr</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=n>fc</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>Addr</span><span class=p>()</span><span class=o>.</span><span class=n>Interface</span><span class=p>(),</span> <span class=n>tx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=n>db</span><span class=o>.</span><span class=n>AddError</span><span class=p>(</span><span class=n>gorm</span><span class=o>.</span><span class=n>ErrInvalidValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续追踪源码发现，Update 的 ReflectValue 是通过 SetupUpdateReflectValue 这个 Hook 函数实现的，最终是来自 db.Statement.Model</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>SetupUpdateReflectValue</span><span class=p>(</span><span class=n>db</span> <span class=o>*</span><span class=n>gorm</span><span class=o>.</span><span class=n>DB</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>db</span><span class=o>.</span><span class=n>Error</span> <span class=o>==</span> <span class=n>nil</span> <span class=o>&amp;&amp;</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Schema</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=k>if</span> <span class=o>!</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>CanAddr</span><span class=p>()</span> <span class=o>||</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Model</span> <span class=o>!=</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Dest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span> <span class=o>=</span> <span class=n>reflect</span><span class=o>.</span><span class=n>ValueOf</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>Kind</span><span class=p>()</span> <span class=o>==</span> <span class=n>reflect</span><span class=o>.</span><span class=n>Ptr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=o>.</span><span class=n>Elem</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=n>dest</span><span class=p>,</span> <span class=n>ok</span> <span class=p>:</span><span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Dest</span><span class=o>.</span><span class=p>(</span><span class=n>map</span><span class=p>[</span><span class=n>string</span><span class=p>]</span><span class=n>interface</span><span class=p>{});</span> <span class=n>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>             <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>rel</span> <span class=p>:</span><span class=o>=</span> <span class=nb>range</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Schema</span><span class=o>.</span><span class=n>Relationships</span><span class=o>.</span><span class=n>BelongsTo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>_</span><span class=p>,</span> <span class=n>ok</span> <span class=p>:</span><span class=o>=</span> <span class=n>dest</span><span class=p>[</span><span class=n>rel</span><span class=o>.</span><span class=n>Name</span><span class=p>];</span> <span class=n>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                   <span class=n>db</span><span class=o>.</span><span class=n>AddError</span><span class=p>(</span><span class=n>rel</span><span class=o>.</span><span class=n>Field</span><span class=o>.</span><span class=n>Set</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>Context</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Statement</span><span class=o>.</span><span class=n>ReflectValue</span><span class=p>,</span> <span class=n>dest</span><span class=p>[</span><span class=n>rel</span><span class=o>.</span><span class=n>Name</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>             <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>       <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>关键点在于 <code>db.Statement.Model</code> 的赋值机制：</p><ol><li><code>Model</code> 方法通常传入一个空结构体：<code>db.Model(&amp;GatewayTasks{})</code></li><li>Update 回调在与数据库交互后会更新 <code>db.Statement.Model</code></li><li>AfterUpdate Hook 中的 <code>tx</code> 参数即是这个更新后的 <code>Statement</code></li></ol><h2 id=根本原因>根本原因<a hidden class=anchor aria-hidden=true href=#根本原因>#</a></h2><p>问题的根源在于 <code>Update</code> 调用时仅更新部分字段（如 <code>taskStatus</code>），而未包含构建缓存所需的 <code>taskID</code> 和 <code>taskType</code>。这导致 Hook 函数虽然执行，但无法正确设置缓存。
而 Create 时，包含了这些字段，导致在 Create 阶段产生了缓存，后续的更新操作未更新缓存，导致了脏数据。</p><h1 id=解决方法>解决方法<a hidden class=anchor aria-hidden=true href=#解决方法>#</a></h1><p>通过分析业务代码发现，更新任务之前，都会先拿到任务信息，都具备获取到 Model 结构体。
调整更新逻辑：</p><ol><li>更新前获取完整任务信息</li><li>直接修改 Model 中需要变更的值</li><li>使用完整 Model 执行 Update 操作</li></ol><h1 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h1><ul><li>GORM 不会凭空产生数据，并不具备类似 binlog 的能力</li><li>GORM Hook 中的 Model 的数据，是从 Update 方法中解析出来的</li><li>在使用 Hook 时，一定要清楚 Model 中哪些字段能够拿到，哪些拿不到</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://jackcipher.github.io/tags/gorm/>Gorm</a></li><li><a href=https://jackcipher.github.io/tags/go/>Go</a></li></ul><nav class=paginav><a class=prev href=https://jackcipher.github.io/posts/radio-frequency-exam/><span class=title>« 上一页</span><br><span>无线电考试中频率相关的考题</span>
</a><a class=next href=https://jackcipher.github.io/posts/gorm-v1.25/><span class=title>下一页 »</span><br><span>GORM v1.25 错误处理机制的变化</span></a></nav></footer><style>.utterances{border-radius:var(--radius);transition:height .3s}</style><script src=https://utteranc.es/client.js repo=jackcipher/blog-comments issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://jackcipher.github.io/>Jack</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>