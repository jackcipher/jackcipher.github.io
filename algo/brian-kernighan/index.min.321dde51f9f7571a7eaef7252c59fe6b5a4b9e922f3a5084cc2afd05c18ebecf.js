(function(){const n=document.querySelector(".algo-viz");if(!n)return;let e={originalN:0,currentN:0,history:[],stepIndex:-1,isPlaying:!1,timer:null};const c=8,t={n:n.querySelector("#bits-n"),minus:n.querySelector("#bits-minus"),res:n.querySelector("#bits-res"),input:n.querySelector("#inputN"),btnLoad:n.querySelector("#btnLoad"),explainer:n.querySelector("#step-explainer"),btnNext:n.querySelector("#btnNext"),btnPrev:n.querySelector("#btnPrev"),btnAuto:n.querySelector("#btnAuto"),speedRange:n.querySelector("#speedRange"),valDec:n.querySelector("#val-dec"),valCount:n.querySelector("#val-count"),valIter:n.querySelector("#val-iter"),lines:n.querySelectorAll(".code-line")};function d(e){let t=e.toString(2).padStart(c,"0");return t.split("").map(e=>parseInt(e))}function l(){r();let s=parseInt(t.input.value);(s!=s||s<0)&&(s=0),s>255&&(alert("仅支持 0-255 (8位演示)"),s=255,t.input.value=255),e.originalN=s,e.currentN=s,e.history=[],e.stepIndex=-1;let n=s,i=0;for(e.history.push({n,n_minus_1:null,result:null,count:0,phase:"start",highlightBit:-1});n>0;){let t=n-1,s=n&t,o=Math.log2(n&-n),a=c-1-o;i++,e.history.push({n,n_minus_1:t,result:s,count:i-1,phase:"calc",highlightBit:a}),n=s,e.history.push({n,n_minus_1:null,result:null,count:i,phase:"update",highlightBit:-1})}e.history.push({n:0,n_minus_1:null,result:null,count:i,phase:"end",highlightBit:-1}),o()}function i(e,t,n=-1,s=!1){if(e.innerHTML="",t===null){e.innerHTML='<span style="color:#555;">...</span>';return}d(t).forEach((t,o)=>{const i=document.createElement("div");i.className=`bit ${t?"on":""}`,i.innerText=t,o===n&&s&&i.classList.add("target"),e.appendChild(i)})}function s(e){if(t.lines.forEach(e=>e.classList.remove("active")),e){const t=n.querySelector(`#line-${e}`);t&&t.classList.add("active")}}function o(){if(!e.history||e.history.length===0)return;e.stepIndex<0&&(e.stepIndex=0),e.stepIndex>=e.history.length&&(e.stepIndex=e.history.length-1);const n=e.history[e.stepIndex];switch(i(t.n,n.n,n.highlightBit,n.phase==="calc"),i(t.minus,n.n_minus_1),i(t.res,n.result),t.valDec.innerText=n.n,t.valCount.innerText=n.count,t.valIter.innerText=Math.ceil(e.stepIndex/2),n.phase){case"start":t.explainer.innerHTML="初始化完成。准备进入循环。",s(3);break;case"calc":t.explainer.innerHTML=`<span style="color:var(--highlight);font-weight:bold">红色高亮</span> 为最右侧的 1。n-1 将其翻转。`,s(6);break;case"update":t.explainer.innerHTML="运算结果更新给 n，计数 +1。",s(7);break;case"end":t.explainer.innerHTML=`n 已为 0，算法结束。共找到 ${n.count} 个 1。`,s(9);break}t.btnPrev.disabled=e.stepIndex===0,t.btnNext.disabled=e.stepIndex===e.history.length-1,t.btnPrev.innerText="上一步",t.btnNext.innerText="下一步",t.btnAuto.disabled=e.stepIndex===e.history.length-1&&!e.isPlaying,t.btnAuto.innerText=e.isPlaying?"暂停":"自动",t.btnAuto.classList.toggle("secondary",!e.isPlaying)}function a(t){e.stepIndex+=t,o(),e.stepIndex>=e.history.length-1&&r()}function u(){if(e.isPlaying)r();else{e.stepIndex>=e.history.length-1&&(e.stepIndex=-1),e.isPlaying=!0,o();let n=1600-parseInt(t.speedRange.value);e.timer=setInterval(()=>{a(1)},n)}}function r(){e.isPlaying=!1,clearInterval(e.timer),o()}t.btnLoad&&t.btnLoad.addEventListener("click",l),t.btnPrev&&t.btnPrev.addEventListener("click",()=>a(-1)),t.btnNext&&t.btnNext.addEventListener("click",()=>a(1)),t.btnAuto&&t.btnAuto.addEventListener("click",u),l()})()